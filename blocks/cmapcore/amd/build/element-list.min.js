define(["jquery","core/ajax"],function(a,b){function c(b){var c,d,e=a("fieldset .ftags select#id_tags_officialtags > option");0!==e.length&&a(".presentation-list li").prepend('<input type="checkbox">'),a(".presentation-list li input").change(function(){c=a(this).parent().text(),d=a(this),e.each(function(b,e){c=c.replace(",",""),c.indexOf(e.value)>-1&&(d.prop("checked")?a(e).attr("selected","selected"):a(e).removeAttr("selected"))})})}function d(b,d,e){var f=[],g={p:{abbrev:"pres",linkname:"presentationlinks",nameprop:"presentation_name",idprop:"presentation_id",mapui:"/ui/presentations"},c:{abbrev:"cond",linkname:"conditionlinks",nameprop:"condition_name",idprop:"condition_id",mapui:"/ui/conditions"},a:{abbrev:"acty",linkname:"activitylinks",nameprop:"activity_name",idprop:"activity_id",mapui:"/ui/activities"}};if(e&&d){var h=d+"/api/modules/"+e+"/"+g[b].linkname+"/?format=json&linkage=strong&page_size=999",i="#cmap-"+g[b].abbrev+"-div",j=a(i),k=j.find(".noelements"),l=j.find(".elementlist"),m=j.find(".loading");console.log("showing loadingmsg for "+b),m.show(),a.getJSON(h,function(e){var h=[];0===e.count?(m.hide(),k.show(),l.hide()):(m.hide(),a.each(e.results,function(a,c){itemtext="<li id='"+a+"'><a target='_blank' href='"+d+g[b].mapui+"/"+c[g[b].idprop]+"'>"+c[g[b].nameprop]+"</a></li>",f.push(c[g[b].nameprop]),h.push(itemtext)}),a("<ul/>",{html:h.join("")}).appendTo(l),l.show(),c(f))}).fail(function(a){m.hide(),k.show()})}else m.hide(),k.show()}return{init:function(b,c,e){if(!this.initialized){a(".pres-loading").show(),"undefined"==typeof b&&(b="https://medmap.otago.ac.nz");var f=b+"/api/modules/"+e+"/",g=a(".block.block_cmapcore:not(.block_with_controls)");a.ajax({url:f,success:function(a,c,f){console.log("got data: ",a),g.show(),d("p",b,e),d("c",b,e),d("a",b,e)},statusCode:{404:function(){console.log("module '"+e+"' not found in cmap"),g.hide()}}})}}}});