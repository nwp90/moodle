define(["jquery","core/ajax"],function(a,b){function c(b){var c,d,e=a("fieldset .ftags select#id_tags_officialtags > option");0!==e.length&&a(".presentation-list li").prepend('<input type="checkbox">'),a(".presentation-list li input").change(function(){c=a(this).parent().text(),d=a(this),e.each(function(b,e){c=c.replace(",",""),c.indexOf(e.value)>-1&&(d.prop("checked")?a(e).attr("selected","selected"):a(e).removeAttr("selected"))})})}function d(b,d){var e=[],g={p:{abbrev:"pres",linkname:"presentationlinks",nameprop:"presentation_name",idprop:"presentation_id",mapui:"/ui/presentations"},c:{abbrev:"cond",linkname:"conditionlinks",nameprop:"condition_name",idprop:"condition_id",mapui:"/ui/conditions"},a:{abbrev:"acty",linkname:"activitylinks",nameprop:"activity_name",idprop:"activity_id",mapui:"/ui/activities"}};if(d){var h=d+"/"+g[b].linkname+"/?format=json&linkage=strong&page_size=999",i="#cmap-"+g[b].abbrev+"-div",j=a(i),k=j.find(".noelements"),l=j.find(".elementlist"),m=j.find(".loading");m.show(),a.getJSON(h,function(d){var h=[];0===d.count?(m.hide(),k.show(),l.hide()):(m.hide(),a.each(d.results,function(a,c){itemtext="<li id='"+a+"'><a target='_blank' href='"+f+g[b].mapui+"/"+c[g[b].idprop]+"'>"+c[g[b].nameprop]+"</a></li>",e.push(c[g[b].nameprop]),h.push(itemtext)}),a("<ul/>",{html:h.join("")}).appendTo(l),l.show(),c(e))}).fail(function(a){m.hide(),k.show()})}else m.hide(),k.show()}function e(b){return function(c,e,f){var g=c.modulesversion.url,h=g+"modules/"+b+"/",i=a(".block.block_cmapcore:not(.block_with_controls)");a.ajax({url:h,success:function(a,b,c){i.show(),d("p",a.url),d("c",a.url),d("a",a.url)},statusCode:{404:function(){console.log("module '"+b+"' not found in cmap default site version"),i.hide()}}})}}var f="https://medmap.otago.ac.nz";return{init:function(b,c,d){if(!this.initialized){a(".pres-loading").show(),"undefined"!=typeof b&&(this.mapbase=b);var f=this.mapbase+"/cmapapi/siteversions/default/";a.ajax({url:f,success:e(d),statusCode:{404:function(){console.log("default site version not found in cmap"),cmapcore.hide()},500:function(){console.log("error fetching default site version from cmap"),cmapcore.hide()}}})}}}});