{"version":3,"sources":["../src/element-list.js"],"names":["define","$","matchTagList","pres","presInput","tags","length","prepend","change","parent","text","each","key","val","replace","indexOf","value","prop","attr","removeAttr","getModuleElements","elementtype","moduleUrl","elements","config","p","abbrev","linkname","nameprop","idprop","mapui","c","a","elementUrl","elementdivstring","elementdiv","nonediv","find","elementlist","loadingmsg","show","getJSON","data","items","count","hide","results","itemtext","push","html","join","appendTo","fail","getAllElements","shortname","siteversionData","modulesversionUrl","modulesversion","url","cmapcore","ajax","success","moduleData","statusCode","console","log","init","mapbase","courseid","initialized","svUrl"],"mappings":"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","sourcesContent":["define([\n  'jquery',\n  'core/ajax'\n], function (\n  $,\n  ajax\n) {\n  var initialized = false;\n  var mapbase = 'https://medmap.otago.ac.nz';\n\n  function matchTagList(presentations) {\n    var pres;\n    var presInput;\n    // match tags\n    var tags = $( 'fieldset .ftags select#id_tags_officialtags > option');\n    \n    if (tags.length !== 0) {\n      $('.presentation-list li').prepend('<input type=\"checkbox\">');\n    }\n    \n    $('.presentation-list li input').change(function() {\n      pres = $(this).parent().text();\n      presInput = $(this);\n      tags.each(function(key, val) {\n\tpres = pres.replace(',', '');\n\tif (pres.indexOf(val.value) > -1) {\n\t  if (presInput.prop('checked')) {\n\t    $(val).attr('selected', 'selected');\n\t  } else {\n\t    $(val).removeAttr('selected');\n\t  }\n\t}\n      });\n    });\n  }\n  \n  function getModuleElements(elementtype, moduleUrl) {\n    var elements = [];\n    var config = {\n      p: {\n\tabbrev: 'pres',\n\tlinkname: 'presentationlinks', // URL component for this type in map API\n\tnameprop: 'presentation_name', // element name property in returned data\n\tidprop: 'presentation_id', // element id property in returned data\n\tmapui: '/ui/presentations' // path for map frontend URL\n      },\n      c: {\n\tabbrev: 'cond',\n\tlinkname: 'conditionlinks', // URL component for this type in map API\n\tnameprop: 'condition_name', // element name property in returned data\n\tidprop: 'condition_id', // element id property in returned data\n\tmapui: '/ui/conditions' // path for map frontend URL\n      },\n      a: {\n\tabbrev: 'acty',\n\tlinkname: 'activitylinks', // URL component for this type in map API\n\tnameprop: 'activity_name', // element name property in returned data\n\tidprop: 'activity_id', // element id property in returned data\n\tmapui: '/ui/activities' // path for map frontend URL\n      }\n    }\n      \n    if (moduleUrl) {\n      // currently, page_size=all gets rid of count, next, prev etc...\n      var elementUrl = moduleUrl + '/' + config[elementtype].linkname + '/?format=json&linkage=strong&page_size=999';\n\n      var elementdivstring = '#cmap-' + config[elementtype].abbrev + '-div';\n      var elementdiv = $(elementdivstring);\n      var nonediv = elementdiv.find('.noelements');\n      var elementlist = elementdiv.find('.elementlist');\n      var loadingmsg = elementdiv.find('.loading');\n\n      //console.log(\"showing loadingmsg for \" + elementtype);\n      loadingmsg.show();\n      $.getJSON(elementUrl, function(data) {\n\tvar items = [];\n\tif (data.count === 0) {\n\t  loadingmsg.hide();\n\t  nonediv.show();\n\t  elementlist.hide();\n\t}\n\telse {\n\t  loadingmsg.hide();\n\t  $.each( data.results, function( key, val ) {\n\t    itemtext = \"<li id='\" + key + \"'><a target='_blank' href='\" + mapbase + config[elementtype].mapui + \"/\" + val[config[elementtype].idprop] + \"'>\" + val[config[elementtype].nameprop] + \"</a></li>\";\n\t    elements.push(val[config[elementtype].nameprop]);\n\t    items.push(itemtext);\n\t  });\n\t  $( \"<ul/>\", {\n\t    html: items.join(\"\")\n\t  }).appendTo(elementlist);\n\t  elementlist.show();\n\t  matchTagList(elements);\n\t}\n       \n     }).fail(function(ex) {\n\tloadingmsg.hide();\n\tnonediv.show();\n     });\n    } else {\n      loadingmsg.hide();\n      nonediv.show();\n    }\n  }\n\n  \n  function getAllElements(shortname) {\n    return (\n      function (siteversionData, textStatus, jqXHR) {\n\tvar modulesversionUrl = siteversionData.modulesversion.url;\n\t\n\t// Check whether module exists in map before trying to get elements;\n\t// if it doesn't, hide the CMap block unless editing is on.\n\t//\n\t// Ideally this would probably be done in the block PHP, and we would\n\t// never even get called when the module doesn't make sense.\n\t//\n\tvar courseUrl = modulesversionUrl + 'modules/' + shortname + '/';\n\tvar cmapcore = $(\".block.block_cmapcore:not(.block_with_controls)\");\n\t$.ajax({\n\t  url: courseUrl,\n\t  success: function(moduleData, textStatus, jqXHR) {\n\t    //console.log(\"got data: \", moduleData);\n\t    cmapcore.show();\n\t    getModuleElements('p', moduleData.url);\n\t    getModuleElements('c', moduleData.url);\n\t    getModuleElements('a', moduleData.url);\n\t  },\n\t  statusCode: {\n\t    404: function() {\n\t      console.log(\"module '\" + shortname + \"' not found in cmap default site version\");\n\t      cmapcore.hide();\n\t    }\n\t  }\n\t});\n      }\n    );\n  }\n    \n  return ({\n    init: function(mapbase, courseid, shortname) {\n      if (!this.initialized) {\n\t$('.pres-loading').show();\n\n\tif (typeof(mapbase) !== 'undefined') {\n\t  this.mapbase = mapbase;\n\t}\n\n\tvar svUrl = this.mapbase + '/cmapapi/siteversions/default/';\n\n\t// getAllEvents *returns* the callback function, which is called\n\t// with (siteversionData, textStatus, jqXHR)\n\t$.ajax({\n\t  url: svUrl,\n\t  success: getAllElements(shortname),\n\t  statusCode: {\n\t    404: function() {\n\t      console.log(\"default site version not found in cmap\");\n\t      cmapcore.hide();\n\t    },\n\t    500: function() {\n\t      console.log(\"error fetching default site version from cmap\");\n\t      cmapcore.hide();\n\t    }\n\t  }\n\t});\n      }\n    }\n  });\n});\n"],"file":"element-list.min.js"}