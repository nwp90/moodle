define(["jquery","block_myoverview/repository","core/paged_content_factory","core/pubsub","core/custom_interaction_events","core/notification","core/templates","core_course/events","block_myoverview/selectors"],function(a,b,c,d,e,f,g,h,i){var j={COURSE_REGION:'[data-region="course-view-content"]',ACTION_HIDE_COURSE:'[data-action="hide-course"]',ACTION_SHOW_COURSE:'[data-action="show-course"]',ACTION_ADD_FAVOURITE:'[data-action="add-favourite"]',ACTION_REMOVE_FAVOURITE:'[data-action="remove-favourite"]',FAVOURITE_ICON:'[data-region="favourite-icon"]',ICON_IS_FAVOURITE:'[data-region="is-favourite"]',ICON_NOT_FAVOURITE:'[data-region="not-favourite"]',PAGED_CONTENT_CONTAINER:'[data-region="page-container"]'},k={COURSES_CARDS:"block_myoverview/view-cards",COURSES_LIST:"block_myoverview/view-list",COURSES_SUMMARY:"block_myoverview/view-summary",NOCOURSES:"block_myoverview/no-courses"},l=[12,24,48],m=[],n=0,o=0,p=0,q=function(a){var b=a.find(i.courseView.region);return{display:b.attr("data-display"),grouping:b.attr("data-grouping"),sort:b.attr("data-sort")}},r={ignoreControlWhileLoading:!0,controlPlacementBottom:!0},s=function(a,c){return b.getEnrolledCoursesByTimeline({offset:n,limit:c,classification:a.grouping,sort:a.sort})},t=function(a,b){return a.find(j.FAVOURITE_ICON+'[data-course-id="'+b+'"]')},u=function(a,b){return a.find('[data-region="paged-content-page"][data-page="'+b+'"]')},v=function(a){return a.attr("data-course-id")},w=function(a,b){var c=t(a,b),d=c.find(j.ICON_IS_FAVOURITE);d.addClass("hidden"),d.attr("aria-hidden",!0);var e=c.find(j.ICON_NOT_FAVOURITE);e.removeClass("hidden"),e.attr("aria-hidden",!1)},x=function(a,b){var c=t(a,b),d=c.find(j.ICON_IS_FAVOURITE);d.removeClass("hidden"),d.attr("aria-hidden",!1);var e=c.find(j.ICON_NOT_FAVOURITE);e.addClass("hidden"),e.attr("aria-hidden",!0)},y=function(a,b){return a.find('[data-action="add-favourite"][data-course-id="'+b+'"]')},z=function(a,b){return a.find('[data-action="remove-favourite"][data-course-id="'+b+'"]')},A=function(a,b){var c=z(a,b),e=y(a,b);D(b,!0).then(function(g){g?(d.publish(h.favourited),c.removeClass("hidden"),e.addClass("hidden"),x(a,b)):f.alert("Starring course failed","Could not change favourite state")})["catch"](f.exception)},B=function(a,b){var c=z(a,b),e=y(a,b);D(b,!1).then(function(g){g?(d.publish(h.unfavorited),c.addClass("hidden"),e.removeClass("hidden"),w(a,b)):f.alert("Starring course failed","Could not change favourite state")})["catch"](f.exception)},C=function(b,d){var e=v(d),h=b.find('[data-region="paging-bar"]'),i=parseInt(h.attr("data-active-page-number")),j=m[i],k=j.courses.reduce(function(a,b){return e!=b.id&&a.push(b),a},[]);if(void 0!=m[i+1]){var l=m[i+1].courses.slice(0,1);m.forEach(function(b,c){if(c>i){var d=[];void 0!=m[c+1]&&(d=m[c+1].courses.slice(0,1)),m[c].courses=a.merge(m[c].courses.slice(1),d)}}),k=a.merge(k,l)}if(o==i+1&&0==m[i+1].courses.length){var p=b.find('[data-region="paged-content-container"]');c.resetLastPageNumber(a(p).attr("id"),i)}m[i].courses=k,n--;var q=u(b,i);E(b,m[i]).then(function(a,b){return g.replaceNodeContents(q,a,b)})["catch"](f.exception),m.forEach(function(a,c){if(c>i){var d=u(b,c);d.remove()}})},D=function(a,c){return b.setFavouriteCourses({courses:[{id:a,favourite:c}]}).then(function(b){return 0==b.warnings.length&&(m.forEach(function(b){b.courses.forEach(function(d,e){d.id==a&&(b.courses[e].isfavourite=c)})}),!0)})["catch"](f.exception)},E=function(a,b){var c=q(a),d="";if(d="cards"==c.display?k.COURSES_CARDS:"list"==c.display?k.COURSES_LIST:k.COURSES_SUMMARY,b.courses.length)return g.render(d,{courses:b.courses});var e=a.find(i.courseView.region).attr("data-nocoursesimg");return g.render(k.NOCOURSES,{nocoursesimg:e})},F=function(b){var d=q(b),e=c.createWithLimit(l,function(c,e){var g=[];return c.forEach(function(c){var h=c.pageNumber,i=c.limit;if(p!=i&&(m=[],n=0,o=0),o==h)return e.allItemsLoaded(o),void g.push(E(b,m[h]));p=i,void 0==m[h+1]&&void 0==m[h]&&(i*=2);var j=s(d,i).then(function(d){var f=d.courses,g=0,i=[];if(void 0!=m[h]){i=m[h].courses;var j=i.length;j<c.limit&&(g=c.limit-j,i=a.merge(m[h].courses,f.slice(0,g)))}else g=c.limit,i=f.slice(0,c.limit);m[h]={courses:i};var k=f.slice(g,f.length);return k.length&&(m[h+1]={courses:k}),m[h].courses.length<c.limit?(o=h,e.allItemsLoaded(h)):void 0!=m[h+1]&&m[h+1].courses.length<c.limit&&(o=h+1),n=d.nextoffset,E(b,m[h])})["catch"](f.exception);g.push(j)}),g},r);e.then(function(a,c){return g.replaceNodeContents(b.find(i.courseView.region),a,c)})["catch"](f.exception)},G=function(c){e.define(c,[e.events.activate]),c.on(e.events.activate,j.ACTION_ADD_FAVOURITE,function(b,d){var e=a(b.target).closest(j.ACTION_ADD_FAVOURITE),f=v(e);A(c,f),d.originalEvent.preventDefault()}),c.on(e.events.activate,j.ACTION_REMOVE_FAVOURITE,function(b,d){var e=a(b.target).closest(j.ACTION_REMOVE_FAVOURITE),f=v(e);B(c,f),d.originalEvent.preventDefault()}),c.on(e.events.activate,j.FAVOURITE_ICON,function(a,b){b.originalEvent.preventDefault()}),c.on(e.events.activate,j.ACTION_HIDE_COURSE,function(d,e){var f=a(d.target).closest(j.ACTION_HIDE_COURSE),g=v(f),h={preferences:[{type:"block_myoverview_hidden_course_"+g,value:!0}]};b.updateUserPreferences(h),C(c,f),e.originalEvent.preventDefault()}),c.on(e.events.activate,j.ACTION_SHOW_COURSE,function(d,e){var f=a(d.target).closest(j.ACTION_SHOW_COURSE),g=v(f),h={preferences:[{type:"block_myoverview_hidden_course_"+g,value:null}]};b.updateUserPreferences(h),C(c,f),e.originalEvent.preventDefault()})},H=function(b){b=a(b),m=[],o=0,n=0,b.attr("data-init")||(G(b),b.attr("data-init",!0)),F(b)},I=function(a){m.length>0?m.forEach(function(b,c){var d=u(a,c);E(a,b).then(function(a,b){return g.replaceNodeContents(d,a,b)})["catch"](f.exception)}):H(a)};return{init:H,reset:I}});