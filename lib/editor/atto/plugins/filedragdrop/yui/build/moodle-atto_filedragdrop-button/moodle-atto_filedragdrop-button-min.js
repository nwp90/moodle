YUI.add("moodle-atto_filedragdrop-button",function(e,t){var n="atto_filedragdrop",r='<a href="{{url}}" {{#if id}}id="{{id}}" {{/if}}>{{text}}',i='<img src="{{url}}" {{#if alt}}alt="{{alt}}" {{/if}} style="vertical-align:text-bottom;margin: 0 .5em;" class="img-responsive" {{#if presentation}}role="presentation" {{/if}}{{#if id}}id="{{id}}" {{/if}}/>';e.namespace("M.atto_filedragdrop").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,initializer:function(){this.editor.on("drop",this._handleDragDrop,this)},_handleDragDrop:function(t){var s=this,o=this.get("host"),u=e.Handlebars.compile(r),a=e.Handlebars.compile(i);o.saveSelection(),t=t._event;var f=t.dataTransfer&&t.dataTransfer.files&&t.dataTransfer.files.length;if(f&&!/^image\//.test(t.dataTransfer.files[0].type)){var l=o.get("filepickeroptions").link,c=l.savepath===undefined?"/":l.savepath,h=new FormData,p=0,d="",v=new XMLHttpRequest,m="",g=Object.keys(l.repositories);t.preventDefault(),t.stopPropagation(),h.append("repo_upload_file",t.dataTransfer.files[0]),h.append("itemid",l.itemid);for(var y=0;y<g.length;y++)if(l.repositories[g[y]].type==="upload"){h.append("repo_id",l.repositories[g[y]].id);break}return h.append("env",l.env),h.append("sesskey",M.cfg.sesskey),h.append("client_id",l.client_id),h.append("savepath",c),h.append("ctx_id",l.context.id),p=(new Date).getTime(),d="moodlefile_"+Math.round(Math.random()*1e5)+"-"+p,o.focus(),o.restoreSelection(),m=a({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading",n),id:d}),o.insertContentAtFocusPoint(m),s.markUpdated(),v.onreadystatechange=function(){var t=s.editor.one("#"+d),n,r,i,o;if(v.readyState===4)if(v.status===200){n=JSON.parse(v.responseText);if(n){if(n.error)return t&&t.remove(!0),new M.core.ajaxException(n);r=n,n.event&&n.event==="fileexists"&&(r=n.newfile),i=u({url:r.url,text:r.file||r.filename}),o=e.Node.create(i),t?t.replace(o):s.editor.appendChild(o),s.markUpdated()}}else e.use("moodle-core-notification-alert",function(){new M.core.alert({message:M.util.get_string("servererror","moodle")})}),t&&t.remove(!0)},v.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),v.send(h),!1}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
