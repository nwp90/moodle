define(["jquery"],function(a){var b={store:{},init:function(){a('textarea[name^="answer"]').each(function(){var c=a(this).attr("id").replace("id_answer_",""),d="id_"+c;b.store[d]=[],""!==a(this).val()?a(this).parent().parent().next().addClass("rc-hidden"):a(this).parent().parent().next().addClass("rcw");var e=a(this).parent().parent().next().find("div.rule-creator");e.attr("id","rc_"+c),a(this).parent().parent().next().find("a.rule-creator-btn").attr("id","rc_btn_"+c),e.find('div[class="rc-notice"]').attr("id","rc_notice_"+c),e.find('label[for="term"]').attr("for","rc_term_"+c),e.find('input[name="term"]').attr("id","rc_term_"+c),e.find('input[name="termadd"]').attr("id","rc_termadd_"+c).click(function(){return b.termAdd(c),!1}),e.find('input[name="termexclude"]').attr("id","rc_termexclude_"+c).click(function(){return b.termExclude(c),!1}),e.find('input[name="termor"]').attr("id","rc_termor_"+c).click(function(){return b.termOr(c),!1}),e.find('label[for="template"]').attr("for","rc_template_"+c),e.find('input[name="template"]').attr("id","rc_template_"+c),e.find('input[name="templateadd"]').attr("id","rc_templateadd_"+c).click(function(){return b.templateAdd(c),!1}),e.find('input[name="templateexclude"]').attr("id","rc_templateexclude_"+c).click(function(){return b.templateExclude(c),!1}),e.find('label[for="precedesadd"]').attr("for","rc_precedes1_"+c),e.find('select[name="precedes1"]').attr("id","rc_precedes1_"+c),e.find('select[name="precedes2"]').attr("id","rc_precedes2_"+c),e.find('input[name="precedesadd"]').attr("id","rc_precedesadd_"+c).click(function(){return b.precedesAdd(c),!1}),e.find('label[for="cprecedesadd"]').attr("for","rc_cprecedes1_"+c),e.find('select[name="cprecedes1"]').attr("id","rc_cprecedes1_"+c),e.find('select[name="cprecedes2"]').attr("id","rc_cprecedes2_"+c),e.find('input[name="cprecedesadd"]').attr("id","rc_cprecedesadd_"+c).click(function(){return b.cprecedesAdd(c),!1}),e.find("div.rc-result").attr("id","rc_result_"+c),e.find('input[name="add"]').attr("id","rc_add_"+c).click(function(){return b.addToAnswer(c),!1}),e.find('input[name="clear"]').attr("id","rc_clear_"+c).click(function(){return b.clear(c),!1})}),a(".rule-creator-btn").click(function(b){var c=a(b.target).closest(".fitem.rcw"),d=a(b.target).closest(".rule-creator-btn").find("img.icon"),e=d.attr("src");return c.find(".rule-creator").slideToggle(),void 0!==e&&(e=e.indexOf("collapsed")>0?e.slice(0,-9)+"expanded":e.slice(0,-8)+"collapsed",d.attr("src",e),!1)})},termAdd:function(b){var c=this.getTerm(b,"term");if(!c)return void a("#rc_term_"+b).focus();var d=this.addToStore(b,c,"and","term");this.addToPrecedes(b,d,c),this.displayResult(b),a("#rc_term_"+b).val("")},termExclude:function(b){var c=this.getTerm(b,"term");return c?(this.addToStore(b,c,"not","term"),this.disablePrecedes(b,!0),this.displayResult(b),void a("#rc_term_"+b).val("")):void a("#rc_term_"+b).focus()},termOr:function(b){var c=this.getTerm(b,"term");if(!c)return void a("#rc_term_"+b).focus();var d=this.addToStore(b,c,"or","term");this.addToPrecedes(b,d,c),this.displayResult(b),a("#rc_term_"+b).val("")},templateAdd:function(b){var c=this.getTerm(b,"template");if(!c)return void a("#rc_template_"+b).focus();var d=this.addToStore(b,c,"and","template");this.addToPrecedes(b,d,c),this.displayResult(b),a("#rc_template_"+b).val("")},templateExclude:function(b){var c=this.getTerm(b,"template");return c?(this.addToStore(b,c,"not","template"),this.disablePrecedes(b,!0),this.displayResult(b),void a("#rc_template_"+b).val("")):void a("#rc_template_"+b).focus()},precedesAdd:function(a){var b=this.getPrecedesChoices(a,"precedes");b&&(this.addToStore(a,b,"and","precedes"),this.removeFromPrecedes(a,b),this.displayResult(a))},cprecedesAdd:function(a){var b=this.getPrecedesChoices(a,"cprecedes");b&&(this.addToStore(a,b,"and","cprecedes"),this.removeFromPrecedes(a,b),this.displayResult(a))},addToAnswer:function(b){var c=a("#rc_result_"+b).text();null!==c&&""!==c&&(a("#id_answer_"+b).val(c),this.clear(),a("#rc_btn_"+b).click(),a("#id_fraction_"+b).val("1.0").change(),a("#id_answer_"+b).focus())},clear:function(b){var c="id_"+b;this.store[c]=[],a("#rc_term_"+b).val(""),a("#rc_template_"+b).val(""),a("#rc_result_"+b).text(""),this.resetPrecedes(b)},getTerm:function(b,c){if(this.getStoreLength(b)>4)return a("#rc_notice_"+b).text(M.util.get_string("rulecreationtoomanyterms","qtype_pmatch")),!1;var d=a("#rc_"+c+"_"+b).val();return void 0!==d&&null!==d&&""!==d&&(d=d.trim(),""!==d&&(!(d.indexOf(" ")>-1)&&(d.indexOf("_")>-1&&(d=d.replace(/_/g,"\\_")),"term"===c?d:"*"===d.slice(-1)?d:d+"*")))},getPrecedesChoices:function(b,c){var d=a("#rc_"+c+"1_"+b).val();if("0"===d)return a("#rc_"+c+"1_"+b).focus(),!1;var e=a("#rc_"+c+"2_"+b).val();return"0"===e?(a("#rc_"+c+"2_"+b).focus(),!1):d===e?(a("#rc_"+c+"2_"+b).focus(),!1):[d,e]},addToPrecedes:function(b,c,d){a("#rc_precedes1_"+b).append(a("<option>",{value:c}).text(d)),a("#rc_precedes2_"+b).append(a("<option>",{value:c}).text(d)),a("#rc_cprecedes1_"+b).append(a("<option>",{value:c}).text(d)),a("#rc_cprecedes2_"+b).append(a("<option>",{value:c}).text(d))},disablePrecedes:function(b,c){a("#rc_precedes1_"+b).prop("disabled",c),a("#rc_precedes2_"+b).prop("disabled",c),a("#rc_cprecedes1_"+b).prop("disabled",c),a("#rc_cprecedes2_"+b).prop("disabled",c)},resetPrecedes:function(b){this.disablePrecedes(b,!1),a("#rc_precedes1_"+b).find('option[value!="0"]').remove(),a("#rc_precedes2_"+b).find('option[value!="0"]').remove(),a("#rc_cprecedes1_"+b).find('option[value!="0"]').remove(),a("#rc_cprecedes2_"+b).find('option[value!="0"]').remove()},removeFromPrecedes:function(b,c){var d;for(d=0;d<2;d++)a("#rc_precedes1_"+b+' option[value="'+c[d]+'"]').remove(),a("#rc_precedes2_"+b+' option[value="'+c[d]+'"]').remove(),a("#rc_cprecedes1_"+b+' option[value="'+c[d]+'"]').remove(),a("#rc_cprecedes2_"+b+' option[value="'+c[d]+'"]').remove()},addToStore:function(a,b,c,d){var e="id_"+a,f=this.store[e].length+1;return this.store[e].push({termid:f,term:b,op:c,type:d}),f},getStoreLength:function(a){var b="id_"+a;return this.store[b].length},getStoredResult:function(b){var c="id_"+b,d="",e=[],f=this.store[c].slice(0),g=f.length,h=0,i=0,j=0,k=[],l=0;if(0===g)return d;for(h=0;h<g;h++){var m="";"term"===f[h].type&&("and"===f[h].op&&(m="match_w("+f[h].term+")"),"or"===f[h].op&&(m="match_w("+f[h].term+")",h>0&&k.push(h)),"not"===f[h].op&&(m="not(match_w("+f[h].term+"))")),"template"===f[h].type&&("and"===f[h].op&&(m="match_wm("+f[h].term+")"),"not"===f[h].op&&(m="match_wm("+f[h].term+")")),"precedes"===f[h].type&&(i=f[h].term[0]-1,j=f[h].term[1]-1,m=" match_w("+f[i].term+" "+f[j].term+")"),"cprecedes"===f[h].type&&(i=f[h].term[0]-1,j=f[h].term[1]-1,m=" match_w("+f[i].term+"_"+f[j].term+")"),e.push(m)}if(g=e.length,0===g)return"";if(1===g)return e[0];if(l=k.length,0===l){for(d="match_all(\n  "+e[0],h=1;h<g;h++)d=d+" "+e[h];return d+="\n)"}if(g===l+1){for(d="match_any(\n  "+e[0],h=1;h<g;h++)d=d+" "+e[h];return d+="\n)"}if(1===l)if(1===k[0])if(2===g)d="match_any(\n  "+e[0]+" "+e[1]+"\n)";else{for(d="match_all(\n  match_any(\n    "+e[0]+" "+e[1]+"\n  )\n ",h=2;h<g;h++)d=d+" "+e[h];d+="\n)"}else{for(d="match_all(\n    "+e[0],h=1;h<k[0];h++)d=d+" "+e[h];if(d="match_any(\n  "+d+"\n  )\n  "+e[k[0]]+"\n)",g>k[0]+1){for(d="match_all(\n"+d+"\n",h=k[0]+1;h<g;h++)d=d+" "+e[h];d+="\n)"}}else{if(2!==l)return a("#rc_notice_"+b).text(M.util.get_string("rulecreationtoomanyors","qtype_pmatch")),"";if(1===k[0])if(d="match_any(\n  "+e[0]+" "+e[1],2===k[1]){for(d="match_all(\n"+d+" "+e[2]+"\n)\n",h=3;h<g;h++)d=d+" "+e[h];d+="\n)"}else{for(d="match_all(\n"+d+"\n)\n",h=2;h<k[1];h++)d=d+" "+e[h];if(d="match_any(\n"+d+"\n)\n "+e[k[1]],g>k[1]+1){for(d="\nmatch_all(\n"+d,h=k[1]+1;h<g;h++)d=d+" "+e[h];d+="\n)"}d+="\n)"}else{for(d="match_all(\n"+e[0],h=1;h<k[0];h++)d=d+" "+e[h];if(d="match_any(\n"+d+"\n)\n  "+e[k[0]],k[1]===k[0]+1){if(d=d+" "+e[k[1]]+"\n)\n",g>k[1]+1){for(d="match_all(\n"+d,h=k[1]+1;h<g;h++)d=d+" "+e[h];d+="\n)"}}else{for(d="match_all(\n"+d+"\n)\n",h=k[0]+1;h<k[1];h++)d=d+" "+e[h];if(d="match_any(\n"+d+"\n)\n"+e[k[1]]+"\n)\n",g>k[1]+1){for(d="match_all(\n"+d,h=k[1]+1;h<g;h++)d=d+" "+e[h];d+="\n)\n"}}}}return d.trim()},displayResult:function(b){var c=this.getStoredResult(b);a("#rc_result_"+b).text(c)}};return b});