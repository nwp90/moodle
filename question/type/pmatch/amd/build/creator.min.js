define(["jquery","core/str","core/ajax","core/templates","core/key_codes"],function(a,b,c,d,e){var f={newRowId:"",idxLastRow:0,questionId:"",init:function(){f.questionId=a('#attemptsform input[name="id"]').val(),f.table=a("#responses"),f.idxLastRow=f.table.find("tbody tr").length-1,f.disableControlButtonAndSelectionBox(),a("#newresponsebutton").click(function(b){b.preventDefault(),f.idxLastRow++,f.newRowId="qtype-pmatch-new-response_"+f.idxLastRow,d.render("qtype_pmatch/newresponse",{newrowid:f.newRowId}).done(function(b){f.table.append(b),a("html, body").animate({scrollTop:a("#"+f.newRowId).offset().top},800),a(".new-expectedfraction").focus(),M.core_formchangechecker.set_form_changed()}),f.disableControlButtons(!0)});var b=null;a(document).on("keyup paste",".new-response",function(){var c=a(this).val().trim();b&&(M.util.js_complete("checkresponse"),clearTimeout(b)),M.util.js_pending("checkresponse"),b=setTimeout(function(){""===c?f.handleSaveNewResponseButton(!1,""):f.checkResponse(c),M.util.js_complete("checkresponse")},500)}),a(document).on("keydown",".new-response",function(a){if(a.keyCode==e.enter)return f.saveNewResponse(),!1}),a(document).on("keydown",".new-expectedfraction, .new-response, .savenewresponse, .cancelnewresponse",function(a){a.keyCode==e.escape&&f.cancelNewResponse()}),a(document).on("click",".savenewresponse",function(){return f.saveNewResponse()}),a(document).on("click",".cancelnewresponse",function(){f.cancelNewResponse()})},saveNewResponse:function(){var b=a(".new-response").val().trim();if(""!==b){var d=a(".new-expectedfraction").is(":checked")?1:0,e=c.call([{methodname:"qtype_pmatch_create_response",args:{questionid:f.questionId,expectedfraction:d,response:b,curentrow:f.idxLastRow}}],!0);e[0].done(function(b){if("error"===b.status)f.handleSaveNewResponseButton(!1,b.message);else{f.disableControlButtons(!1),a("#"+f.newRowId).detach(),f.table.append(a(b.html));var c=M.util.get_string("testquestionresultssummary","qtype_pmatch",b.counts);a("#testquestion_gradesummary").html(c)}}).fail(function(a){f.handleSaveNewResponseButton(!1,a.message)}),f.disableControlButtonAndSelectionBox(),f.resetFormState()}},cancelNewResponse:function(){a("#"+f.newRowId).remove(),f.disableControlButtons(!1),f.disableControlButtonAndSelectionBox(),f.resetFormState(),f.idxLastRow--},checkResponse:function(a){var b=c.call([{methodname:"qtype_pmatch_check_response",args:{questionid:f.questionId,response:a}}],!0);b[0].done(function(a){var b=!1;"success"==a.status&&(a.message="",b=!0),f.handleSaveNewResponseButton(b,a.message)}).fail(function(a){f.handleSaveNewResponseButton(!1,a.message)})},handleSaveNewResponseButton:function(b,c){b?a(".savenewresponse").removeAttr("disabled"):a(".savenewresponse").attr("disabled","true"),a(".response.error").html(c)},disableControlButtons:function(b){b?(a("#newresponsebutton").attr("disabled","true"),a("#deleteresponsesbutton").attr("disabled","true"),a("#testresponsesbutton").attr("disabled","true")):(a("#newresponsebutton").removeAttr("disabled"),a("#deleteresponsesbutton").removeAttr("disabled"),a("#testresponsesbutton").removeAttr("disabled"))},resetFormState:function(){M.core_formchangechecker.get_form_dirty_state()&&M.core_formchangechecker.reset_form_dirty_state()},disableControlButtonAndSelectionBox:function(){var b=a("#tqheadercheckbox"),c=a("#responses");c.find("tbody tr:not(.emptyrow)").length<=0?(b.attr("disabled",!0),a("#deleteresponsesbutton").attr("disabled","true"),a("#testresponsesbutton").attr("disabled","true")):(b.removeAttr("disabled"),a("#deleteresponsesbutton").removeAttr("disabled"),a("#testresponsesbutton").removeAttr("disabled"))}};return f});