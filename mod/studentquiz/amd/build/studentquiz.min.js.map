{"version":3,"sources":["../src/studentquiz.js"],"names":["define","$","initialise","forcerating","forcecommenting","off","on","$comments","closest","$field","find","questionid","attr","substr","$cmidfield","cmid","$commentlist","children","val","post","M","cfg","wwwroot","save","sesskey","text","trigger","getCommentList","addClass","rate","$that","$ratingStars","removeClass","each","afterquestion","length","filter","name","match","is","hasrated","hasClass","hascommented","submit","ensurePreventUnload","bindButtons","index","id","commentlisturl","get","data","html","enablePreventUnload","disablePreventUnload","window"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript for save rating and save, remove and listing comments\n *\n * @package    mod_studentquiz\n * @copyright  2017 HSR (http://www.hsr.ch)\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* jshint latedef:nofunc */\n\ndefine(['jquery'], function($) {\n    return {\n        initialise: function(forcerating, forcecommenting) {\n\n            // Ajax request POST on CLICK for add comment.\n            $('.studentquiz_behaviour .add_comment').off('click').on('click', function() {\n                var $comments = $(this).closest('.comments');\n                var $field = $comments.find('.add_comment_field');\n                var questionid = $field.attr('name').substr(1);\n                var $cmidfield = $(this).closest('form').find('.cmid_field');\n                var cmid = $cmidfield.attr('value');\n                var $commentlist = $comments.children('.comment_list');\n\n                if ($field.val() == \"\") {\n                    return;\n                }\n\n                $.post(M.cfg.wwwroot + '/mod/studentquiz/save.php',\n                    {save: 'comment', cmid: cmid, questionid: questionid, sesskey: M.cfg.sesskey, text: $field.val()},\n                    function() {\n                        $field.val('');\n                        $field.trigger(\"keyup\");\n                        getCommentList(questionid, $commentlist, cmid);\n\n                        $('.studentquiz_behaviour > .comments > .comment_error').addClass('hide');\n                    }\n                );\n                return;\n            });\n\n            // Ajax request POST on CLICK for add rating.\n            $('.studentquiz_behaviour .rate .rating .rateable').off('click').on('click', function() {\n                var rate = $(this).attr('data-rate');\n                var $that = $(this);\n                var $cmidfield = $(this).closest('form').find('.cmid_field');\n                var cmid = $cmidfield.attr('value');\n                $.post(M.cfg.wwwroot + '/mod/studentquiz/save.php',\n                    {save: 'rate', cmid: cmid, questionid: $(this).attr('data-questionid'), sesskey: M.cfg.sesskey, rate: rate},\n                    function() {\n                        var $ratingStars = $that.closest('.rating').children('span');\n                        $ratingStars.removeClass('star');\n                        $ratingStars.addClass('star-empty');\n                        $ratingStars.each(function() {\n                            if ($(this).attr('data-rate') <= rate) {\n                                $(this).removeClass('star-empty');\n                                $(this).addClass('star');\n                            }\n                        });\n\n                        $('.studentquiz_behaviour > .rate > .rate_error').addClass('hide');\n                    }\n                );\n            });\n\n            // On CLICK check if student submitted result and has rated if not abort and show error for rating.\n            $('input[name=\"next\"], input[name=\"previous\"], input[name=\"finish\"]').off('click').on('click', function() {\n                var $that = $(this);\n\n                var afterquestion = !$('.im-controls input[type=\"submit\"]').length ||\n                    $('.im-controls input[type=\"submit\"]').filter(function() {\n                        return this.name.match(/^q.+-submit$/);\n                    }).is(':disabled');\n                if (afterquestion) {\n                    var hasrated = $('.rating span').hasClass('star');\n                    var hascommented = $('.studentquiz_behaviour .comment_list > div').hasClass('fromcreator');\n\n                    if (forcerating) {\n                        if (!hasrated) {\n                            $('.studentquiz_behaviour > .rate > .rate_error').removeClass('hide');\n                        }\n                    }\n                    if (forcecommenting) {\n                        if (!hascommented) {\n                            $('.studentquiz_behaviour > .comments > .comment_error').removeClass('hide');\n                        }\n                    }\n\n                    if ((!forcerating || hasrated) && (!forcecommenting || hascommented)) {\n                        $that.submit();\n                        return true;\n                    }\n                    return false;\n                } else {\n                    $that.submit();\n                    return true;\n                }\n            });\n\n            $('.add_comment_field').on('keyup', ensurePreventUnload);\n\n            // Bind the show more and show less buttons\n            bindButtons();\n        }\n    };\n\n    /**\n     * Binding action buttons after refresh comment list.\n     */\n    function bindButtons() {\n        $('.studentquiz_behaviour .show_more').off('click').on('click', function() {\n            $('.studentquiz_behaviour .comment_list div').removeClass('hidden');\n            $(this).addClass('hidden');\n            $('.studentquiz_behaviour .show_less').removeClass('hidden');\n        });\n\n        $('.studentquiz_behaviour .show_less').off('click').on('click', function() {\n            $('.studentquiz_behaviour .comment_list > div').each(function(index) {\n                if (index > 10 && !$(this).hasClass('button_controls')) {\n                    $(this).addClass('hidden');\n                }\n            });\n\n            $(this).addClass('hidden');\n            $('.studentquiz_behaviour .show_more').removeClass('hidden');\n        });\n\n        $('.studentquiz_behaviour .remove_action').off('click').on('click', function() {\n            var $cmidfield = $(this).closest('form').find('.cmid_field');\n            var cmid = $cmidfield.attr('value');\n            var questionid = $(this).attr('data-question_id');\n            var $commentlist = $(this).closest('.comments').children('.comment_list');\n            $.post(M.cfg.wwwroot + '/mod/studentquiz/remove.php',\n                {id: $(this).attr('data-id'), cmid: cmid, sesskey: M.cfg.sesskey},\n                function() {\n                    getCommentList(questionid, $commentlist, cmid);\n                }\n            );\n        });\n    }\n\n    /**\n     * Ajax request GET to get comment list\n     * @param {int}           questionid Question id\n     * @param {jQueryElement} $commentlist jQuery HtmlElement for comments list div\n     * @param {int}           cmid course module id\n     */\n    function getCommentList(questionid, $commentlist, cmid) {\n        var commentlisturl = M.cfg.wwwroot + '/mod/studentquiz/comment_list.php?questionid=';\n        commentlisturl += questionid + '&cmid=' + cmid + '&sesskey=' + M.cfg.sesskey;\n        $.get(commentlisturl,\n            function(data) {\n                $commentlist.html(data);\n                bindButtons();\n            }\n        );\n    }\n\n    /**\n     * Kindly ask to prevent leaving page when there's a unsaved comment\n     * \n     * Note: Only in preview is the commenting visible without answering the question. If someone has filled the\n     * textarea and afterwards answers the question, he'll get the dialogue, which is fine.\n     */\n\n    /**\n     * Enable the unload prevention conditionally by comment textarea\n     */\n    function ensurePreventUnload() {\n        if ($('.add_comment_field').val() != \"\") {\n            enablePreventUnload();\n        } else {\n            disablePreventUnload();\n        }\n    }\n\n    /**\n     * Set the beforeunload event.\n     */\n    function enablePreventUnload() {\n        // Kindly warn user when he tries to leave page while he has still input in the comment textarea\n        $(window).on('beforeunload', function() {\n            $('.studentquiz_behaviour > .comments > .comment_error_unsaved').removeClass('hide');\n            return true;\n        });\n    }\n\n    /**\n     * Remove the beforeunload event.\n     */\n    function disablePreventUnload() {\n        $('.studentquiz_behaviour > .comments > .comment_error_unsaved').addClass('hide');\n        $(window).off('beforeunload');\n    }\n});"],"file":"studentquiz.min.js"}