define ("mod_teambuilder/build",["jquery","jqueryui","core/str"],function(b,d,e){var f=85,g,h=1,l=2,m=[],n=[],o=[],p=0,r={},u="",v="",w="",y=function(b){r.any=b[0];r.all=b[1];r.none=b[2];r.or=b[3];r.and=b[4];r.addnewsubcriterion=b[5];r.criterionquestion=b[6];r.criterionsubquestion=b[7];u="<option value=\"any\">"+r.any+"</option>";u+="<option value=\"all\">"+r.all+"</option>";u+="<option value=\"none\">"+r.none+"</option>";v="<div class=\"criterionWrapper\"><div class=\"criterion ui-corner-all\">";v+="<div class=\"criterionDelete\"></div>";v+=r.criterionquestion.replace("{question}","<select class=\"questions\"></select>").replace("{options}","<select class=\"oper\">"+u+"</select>");v+="<div class=\"answers\"></div>";v+="<div class=\"add_sub\">";v+="<a href=\"#\" class=\"addsubcriterion\" title=\""+r.addnewsubcriterion+"\"><img src=\"css/add_sub.png\" /></a>";v+="</div>";v+="<div class=\"subcriteria\"></div>";v+="<div class=\"runningCounter\"></div>";v+="</div><div class=\"boolOper\">"+r.and+"</div></div>";w="<div class=\"subcriterionWrapper\"><div class=\"criterionDelete\"></div>";w+=r.criterionsubquestion.replace("{question}","<select class=\"questions\"></select>").replace("{options}","<select class=\"oper\">"+u+"</select>");w+="<div class=\"answers\"></div></div>"},z=function(){b(".stepper").each(function(){var d=b(this).html(),e=b("<span><div class='ui-stepper-down'></div><span>"+d+"</span><div class='ui-stepper-up'></div></span>");e.find(".ui-stepper-up").click(function(){var b=parseInt(e.find("span").html());b++;e.find("span").html(b);A(b)});e.find(".ui-stepper-down").click(function(){var b=parseInt(e.find("span").html());b--;if(1>b){b=1}e.find("span").html(b);A(b)});b(this).empty();b(this).append(e)});b(".student").each(function(){if(b(this).width()>f){f=b(this).width()}});b(".student").each(function(){b(this).width(f)});b("#unassigned, #teams").on("mouseup",".student",function(d){if(p){p=!1;return}var e=b("<div class=\"studentResponse ui-corner-all\"></div>"),f=/student-(\d+)/.exec(b(this).attr("id")),g=responses[f[1]];if(g){var h=b("<table></table>");e.append(h);for(i in questions){q=questions[i];qr=[];for(j in q.answers){a=q.answers[j];if(-1!=b.inArray(parseInt(a.id),g)){qr.push(a.answer)}}var l=b("<tr><th scope=\"row\">"+q.question+"</th><td>"+qr.join("<br/>")+"</td></tr>");h.append(l)}}else{e.html("This student has not responded.")}b(document.body).append(e);e.css("left",d.pageX);e.css("top",d.pageY);var m=function(d){if(d.target!=e.get(0)){e.remove();b(document).unbind("mousedown",m)}};b(document).mousedown(m);var n,o=function(d){stresponse=b(d.target).closest(".studentResponse");if(d.target!=this&&(0==stresponse.length||0<stresponse.length&&e.get(0)!=stresponse.get(0))){if(n==void 0){n=setTimeout(function(){e.remove()},500)}}else{if(n){clearTimeout(n)}}};b(document).mouseover(o)});b("#teams").on("click",".team > h2",function(d){var f=b(d.target),g=f.html(),h=b("<input type=\"text\" value=\""+g+"\" />");h.css("font-size",f.css("font-size"));h.width(f.width());h.height(f.height());h.css("border-width","0px");function e(){var d=b("<h2>"+h.val()+"</h2>");d.width(h.width());d.height(h.height());h.replaceWith(d);n[d.parent().index()]=d.html()}var l=function(d){if(d.target!=h.get(0)){e();b(document).unbind("mousedown",l)}};b(document).mousedown(l);h.keypress(function(d){if(13==d.keyCode){e();b(document).unbind("mousedown",l)}});f.replaceWith(h);h.focus();h.select()});g=b("#unassigned").html();A(2);E()},A=function(b){G();if(m.length>b){m=m.slice(0,b)}if(n.length>b){n=n.slice(0,b)}else if(n.length<b){for(i=n.length-1;i<b;i++){n[i]="Team "+(i+1)}}H()},B=function(){o=[];for(var d=0;d<m.length;d++){m[d]=[]}H();b("#debug").html("")},C=function(b){var d=I(b);ctr=0;for(i in students){if(!1===responses[i]){continue}if(L(i,d)){ctr++}}b.find(".runningCounter").html(ctr);if(ctr<n.length){b.find(".runningCounter").css("color","#E9AAAA")}else{b.find(".runningCounter").css("color","")}},D=function(d,e){q=questions[d];var f=b("<ul></ul>");for(a in q.answers){answer=q.answers[a];f.append("<li><input type=\"checkbox\" value=\""+answer.id+"\">"+answer.answer+"</input></li>")}e.closest(".criterionWrapper").find(".runningCounter").empty();e.empty().append(f);e.closest(".criterionWrapper").find("ul input,select.oper").change(function(){C(b(this).closest(".criterionWrapper").children(".criterion"))})},E=function(){if(!b("#predicate").length){return}var d=b(v);for(var e in questions){q=questions[e];d.find(".questions").append("<option value=\""+q.id+"\">"+q.question+"</option>")}d.find(".questions").change(function(){D(this.value,b(this).nextAll(".answers:first"));if("one"==questions[this.value].type){b(this).next(".oper").children("[value='all']").remove()}else{b(this).next(".oper").children("[value='all']").remove();b(this).nextAll(".oper:first").children("[value='none']").before("<option value=\"all\">all</option>")}});d.find(".questions *:selected").change();d.find(".criterion").hover(function(){b(this).children(".criterionDelete").fadeIn(100)},function(){b(this).children(".criterionDelete").fadeOut(100)});d.find(".criterionDelete").click(function(){b(this).hide();b(this).closest(".criterionWrapper").prev(".criterionWrapper").find(".boolOper").slideUp(300);b(this).closest(".criterionWrapper").slideUp(300,function(){b(this).remove()})});d.find(".boolOper").click(function(){var d=b(this).html();if(d==r.and){d=r.or}else{d=r.and}b(this).html(d)});d.find(".boolOper").hide();b("#predicate .boolOper").slideDown(100);b("#predicate").append(d);d.slideDown(300)},F=function(d){var e=b(d).closest(".criterionWrapper"),f=b(w);e.find(".subcriteria").append(f);for(var g in questions){q=questions[g];f.find(".questions").append("<option value=\""+q.id+"\">"+q.question+"</option>")}f.find(".questions").change(function(){D(this.value,b(this).nextAll(".answers:first"));if("one"==questions[this.value].type){b(this).next(".oper").children("[value='all']").remove()}else{b(this).nextAll(".oper:first").children("[value='none']").before("<option value=\"all\">all</option>")}});f.find(".questions *:selected").change();f.hover(function(){b(this).find(".criterionDelete").fadeIn(100)},function(){b(this).find(".criterionDelete").fadeOut(100)});f.find(".criterionDelete").click(function(){b(this).hide();b(this).closest(".subcriterionWrapper").slideUp(300,function(){var d=b(this).closest(".criterionWrapper").children(".criterion");b(this).remove();C(d)})})},G=function(){m=[];b(".team").each(function(){var d=b(this),e=b(this).index(),f=[];d.find(".student").each(function(){var d=/student-(\d+)/.exec(b(this).attr("id"));f.push(d[1])});m[e]=f})},H=function(){b("#unassigned").html(g);b("#teams").empty();for(var d=0,e;d<n.length;d++){e=b("<div class=\"team\" id=\"team-"+d+"\" />");e.append("<h2>"+n[d]+"</h2>");e.width(f+30);e.append("<div class=\"sortable\"></div>");b("#teams").append(e)}var h={connectWith:".sortable",start:function start(){p=!0}};b("#teams .sortable").sortable(h);b("#unassigned .sortable").sortable(h);for(d in m){var l=m[d],e=b("#team-"+d+" > div.sortable");for(j in l){var r=l[j],u=b("#student-"+r);u.detach();e.append(u);if(-1!=b.inArray(r,o)){u.css("color","green")}else{u.css("color","")}}}b("#assignrandomly").on("click",M)},I=function(d){var e={question:b(d).children(".questions").find("*:selected").val(),answers:[],oper:b(d).children(".oper").find("*:selected").val()};b(d).children(".answers").find("input:checked").each(function(){e.answers.push(this.value)});e.subcriteria=[];subcriteria=b(d).children(".subcriteria");subcriteria.find(".subcriterionWrapper").each(function(){var d={question:b(this).children(".questions").find("*:selected").val(),answers:[],oper:b(this).children(".oper").find("*:selected").val()};b(this).children(".answers").find("input:checked").each(function(){d.answers.push(this.value)});e.subcriteria.push(d)});return e},J=function(){B();G();o=[];var d=[],e=[];b("#predicate .criterionWrapper").each(function(){var f=I(b(this).children(".criterion"));e.push(f);if(b(this).find(".boolOper").html()==r.and){d.push(e);e=[]}});var f=b("#prioritise").val();unassignedStudents={};assignedStudents={};b("#unassigned .student").each(function(){rslt=/student-(\d+)/.exec(this.id);unassignedStudents[rslt[1]]=students[rslt[1]]});b(".team .student").each(function(){rslt=/student-(\d+)/.exec(this.id);assignedStudents[rslt[1]]=students[rslt[1]]});b.each(responses,function(b,d){if(!1===d){delete assignedStudents[b];delete unassignedStudents[b]}});teamsPriority=[];initTeamsList=[];for(i=0;i<n.length;i++){teamsPriority.push(0);initTeamsList.push(i)}for(i in d){var g=function(d,e){return teamsPriority[d]-teamsPriority[e]},p=function(d,e){return studentPriority[d]-studentPriority[e]};O("Criterion "+i);cg=d[i];ucandidates=[];acandidates=[];ucandidates=K(unassignedStudents,cg);acandidates=K(assignedStudents,cg);studentPriority={};for(j in unassignedStudents){studentPriority[j]=0}for(j=d.length-1;j>i;j--){icandidates=K(unassignedStudents,d[j]);for(k in icandidates){s=icandidates[k];studentPriority[s]++}}O(studentPriority);teamsList=initTeamsList.slice(0);teamsList=P(teamsList);teamsList=teamsList.sort(g);if("numbers"==f){var A=function(d,e){return m[d].length-m[e].length};teamsList=teamsList.sort(A);O("teams list");O(m);O(teamsList);h=2}else{h=1}ucandidates=P(ucandidates);acandidates=P(acandidates);ucandidates=ucandidates.sort(p);if(ucandidates.length>=n.length){O("Best case");O(ucandidates);unassignedStudents=ucandidates;while(0<unassignedStudents.length){var u=0,v=[];for(j=1;j<m.length;j++){t=m[j];lt=m[u];if(t.length<lt.length){u=j;v=[]}else if(t.length==lt.length){v.push(j)}}v.push(u);do{randomTeam=Math.floor(Math.random()*v.length)}while(randomTeam>=v.length);m[v[randomTeam]].push(unassignedStudents.pop())}}else{if(ucandidates.length+acandidates.length<n.length){O("Worst case")}else{O("Worse case")}O(ucandidates);O(acandidates);var w=[],y=[];for(j in teamsList){t=teamsList[j];var z=!0;for(k in acandidates){c=acandidates[k];ta=m[t];if(-1!=b.inArray(c,ta)){z=!1}}if(z){w.push(t);teamsPriority[t]+=l}else{y.push(t);teamsPriority[t]+=h}}for(j in ucandidates){if(j<w.length){t=w[j];s=ucandidates[j];m[t].push(s);teamsPriority[t]-=l}else{x=j-w.length;t=y[x];s=ucandidates[j];m[t].push(s);teamsPriority[t]-=h}}}for(j in m){t=m[j];for(k in unassignedStudents){s=unassignedStudents[k];if(-1!=b.inArray(k,t)){assignedStudents[k]=s;delete unassignedStudents[k];o.push(k)}}}O(m);O(teamsPriority);O("<br/>")}H()},K=function(d,e){candidates=[];for(c in e){criterion=e[c];for(s in d){if(L(s,criterion)){if(-1==b.inArray(s,candidates)){candidates.push(s)}}}}return candidates},L=function(d,e){var f=responses[d];if(!1===f){return!1}var g,h,l;if("any"==e.oper){g=!1;for(a in e.answers){h=parseInt(e.answers[a]);if(-1!=b.inArray(h,f)){g=!0;break}}}else if("all"==e.oper){g=!0;for(a in e.answers){h=parseInt(e.answers[a]);if(-1==b.inArray(h,f)){g=!1;break}}}else if("none"==e.oper){g=!0;for(a in e.answers){h=parseInt(e.answers[a]);if(-1!=b.inArray(h,f)){g=!1}}}if(g&&e.subcriteria){for(i=0;i<e.subcriteria.length;i++){l=e.subcriteria[i];g=L(d,l);if(!1==g){break}}}return g},M=function(){G();var d=[];b("#unassigned .student").each(function(){rslt=/student-(\d+)/.exec(this.id);d.push(rslt[1])});d=P(d);while(0<d.length){var e=0,f=[];for(i=1;i<m.length;i++){t=m[i];lt=m[e];if(t.length<lt.length){e=i;f=[]}else if(t.length==lt.length){f.push(i)}}f.push(e);do{randomTeam=Math.floor(Math.random()*f.length)}while(randomTeam>=f.length);m[f[randomTeam]].push(d.pop())}H()},N=function(){G();var d=b("<form action=\""+window.location+"\" method=\"POST\"></form>");for(i=0;i<n.length;i++){var e=n[i],f=m[i],g=b("<input type=\"hidden\" name=\"teamnames["+i+"]\" value=\""+e+"\" />");d.append(g);var h=b("<input type=\"hidden\" name=\"teams["+i+"]\" value=\""+f.join(",")+"\" />");d.append(h)}var l=b("<input type=\"hidden\" name=\"action\" value=\"create-groups\" />"),o=b("<input type=\"hidden\" name=\"groupingName\" value=\""+b("#groupingName").val()+"\" />"),p=b("<input type=\"hidden\" name=\"groupingID\" value=\""+b("#groupingSelect").val()+"\" />"),r=b("<input type=\"hidden\" name=\"inheritGroupingName\" value=\""+(b("#inheritGroupingName").is(":checked")?1:0)+"\" />"),u=b("<input type=\"hidden\" name=\"nogrouping\" value=\""+(b("#nogrouping").is(":checked")?1:0)+"\" />");d.append(l);d.append(o);d.append(p);d.append(r);d.append(u);b("#createGroupsForm").append(d);d.submit()},O=function(){},P=function(b){var d=[],e=b.slice(0);for(i=e.length;0<i;i--){var f=Math.floor(Math.random()*i);d.push(e[f]);e.splice(f,1)}return d},Q=function(){b("#addnewcriterion").on("click",E);b("#buildteams").on("click",J);b("#resetteams").on("click",B);b("#assignrandomly").on("click",M);b("#creategroups").on("click",N);b("#predicate").delegate(".addsubcriterion","click",function(b){F(b.target)})};return{init:function init(){e.get_strings([{key:"any",component:"mod_teambuilder"},{key:"all",component:"mod_teambuilder"},{key:"none",component:"mod_teambuilder"},{key:"or",component:"mod_teambuilder"},{key:"and",component:"mod_teambuilder"},{key:"addnewsubcriterion",component:"mod_teambuilder"},{key:"criterionquestion",component:"mod_teambuilder"},{key:"criterionsubquestion",component:"mod_teambuilder"}]).done(function(b){y(b);z();Q()})}}});
//# sourceMappingURL=build.min.js.map
